{% extends "blog/layout.html" %}
{% load bootstrap3 %}

{% block extra_body %}
<script>
$(function(){
	var raw_template = $('#comment-template').html();
	var tpl = _.template(raw_template);

	$('#comment-form').submit(function(e){
		e.preventDefault();

		var $form = $(this);
		// this가 현재 form 엘리먼트를 지칭하는것 form에 대헤 맵핑
		var $submit = $form.find('[type=submit]');

		$submit.prop('disabled', true);

		var url = $form.attr('action');
		// 주소를 어디로 쏠건지 정함
		var data = $form.serialize();
		// url encoded된 데이터

		$.post(url, data)
			.done(function(obj){
				console.log("----done----");
				console.log(obj);

				if ( obj.is_success === false ){
					alert(obj.message);
					// 오류를 alert창으로 보여줌
				}
				else {
					$('#comment-list').prepend(tpl(obj));
						$form[0].reset();
				}
			})
			.fail(function(xhr, textStatus, error){
				alert('failed : '+ error)
			})
			.always(function(){
				$submit.prop('disabled', false);
			});
	});

	$(document).on('click','.ajax-post-confirm', function(e){
		e.preventDefault();

		var url = $(this).attr('href');
		var target_id = $(this).data('target-id');
		var message = $(this).data('message');



		if ( confirm(message)){
			$.post(url)
				.done(function(){
					$('#' + target_id).remove();
				})
				.fail(function(xhr, textStatus, error){
					alert('failed : '+error)
				});
		}
	});
});
</script>
{% endblock %}

{% block content %}
<div class="container">
	<div class="row">
		<div class="col-sm-12">
			<h1>{{ post.title }}</h1>

			{{ post.content|linebreaks }}

			<hr/>
			<form id="comment-form" action="{% url "blog:comment_new" post.pk %}" method="post">
				<!-- 현재는 detail인데 comment_new에서 처리하기위해 post요청을 넘겨줘야함
				다른 url로 보낼거기 떄문에 -->
				{% csrf_token %}
				{% bootstrap_form comment_form %}
				<input type="submit" class="btn btn-primary btn-block" />
			</form>

			<!-- <a href="{% url "blog:comment_new" post.pk %}" class="btn btn-primary btn-block">댓글 쓰기</a> -->

			<ul id='comment-list'>
			{% for comment in post.comment_set.all %}
				<li id="comment-{{ comment.pk }}">
				{{ comment.message }}
				&dash; 
				<a href="{% url "blog:comment_edit" post.pk comment.pk %}">
						<small>{{ comment.updated_at }}</small>
				</a>

				<a href="{% url "blog:comment_delete" post.pk comment.pk %}"
					class="ajax-post-confirm"
					data-target-id="comment-{{ comment.pk }}"
					data-message="정말 삭제하시겠습니까?">
					<small>삭제</small>
				</a>

				</li>
			{% endfor %}
			</ul>
			<hr/>

			<a href="{% url "blog:index" %}" class="btn btn-primary">목록</a>
			<a href="{% url "blog:post_edit" post.pk %}" class="btn btn-primary">수정</a>
			<a href="{% url "blog:post_delete" post.pk %}" class="btn btn-danger">삭제</a>
			
		</div>
	</div>
</div>
<script type="text/x-template" id="comment-template">
	<li id="comment-<%= id %>">
		<%= message %>
		&dash;
		<a href="<%= edit_url %>">
			<small><%= updated_at %></small>
		</a>
		<a href="<%= delete_url %>"
		class="ajax-post-confirm"
		data-target-id="comment-<%= id %>"
		data-message="정말 삭제하시겠습니까?">
			<small>삭제</small>
		</a>
	</li>
</script>
{% endblock %}
